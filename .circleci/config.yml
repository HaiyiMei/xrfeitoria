version: 2.1

orbs:
  win: circleci/windows@5.0

jobs:
  build-plugins-linux:
    parameters:
      image:
        type: string
        default: "ghcr.io/epicgames/unreal-engine:dev-5.3"
    docker:
      - image: << parameters.image >>
        auth:
          username: $GHCR_USERNAME
          password: $GHCR_TOKEN
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: "Install Python 3.10"
          command: |
            apt-get update
            apt-get install -y python3.10 python3-pip
            python3 --version
      - run:
          name: "Build Plugins"
          command: |
            python3 -m xrfeitoria.utils.publish_plugins -u "/home/ue4/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"

  build-plugins-windows:
    parameters:
      image:
        type: string
        default: "meihaiyi/ue4-full:5.3.2-ltsc2022-vs2022-py310"
    executor:
      name: win/default
      shell: powershell.exe
    working_directory: ~/project
    steps:
      - checkout
      - run: systeminfo
      - run:
          name: "Build Plugins"
          shell: powershell.exe
          command: |
            docker info
            docker run -it << parameters.image >> -v ~/project:C:/project -w C:/project "python3 -m xrfeitoria.utils.publish_plugins -u C:/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"

workflows:
  build-plugins-workflow: # Name of the workflow
    jobs:
      - build-plugins-linux:
          image: "ghcr.io/epicgames/unreal-engine:dev-5.3"
      - build-plugins-linux:
          image: "ghcr.io/epicgames/unreal-engine:dev-5.2"
      - build-plugins-linux:
          image: "ghcr.io/epicgames/unreal-engine:dev-5.1"
      - build-plugins-windows:
          image: "meihaiyi/ue4-full:5.3.2-ltsc2022-vs2022-py310"
