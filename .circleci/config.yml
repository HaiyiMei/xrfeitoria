version: 2.1

jobs:
  build-plugins:
    parameters:
      image:
        type: string
        default: "ghcr.io/epicgames/unreal-engine:dev-5.3"
      unreal_executable:
        type: string
        default: "/home/ue4/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"
    docker:
      - image: << parameters.image >>
        auth:
          username: $GHCR_USERNAME
          password: $GHCR_TOKEN
    steps:
      # Checkout the code as the first step.
      - checkout
      # Install dependencies
      - run:
          name: "Pip Install"
          command: |
            python3 -m pip install --upgrade pip
            cd $(eval echo $CIRCLE_WORKING_DIRECTORY)
            pip install .
      # Build the plugins
      - run:
          name: "Build Plugins"
          command: |
            cd $(eval echo $CIRCLE_WORKING_DIRECTORY)
            python3 -m xrfeitoria.utils.publish_plugins -u << parameters.unreal_executable >>

workflows:
  build-plugins-workflow: # Name of the workflow
    jobs:
      - build-plugins:
          matrix:
            parameters:
              image:
                # Linux image
                - ghcr.io/epicgames/unreal-engine:dev-5.3
                - ghcr.io/epicgames/unreal-engine:dev-5.2
                - ghcr.io/epicgames/unreal-engine:dev-5.1
                # Windows image
                - ghcr.io/epicgames/unreal-engine:runtime-windows
              unreal_executable:
                # Linux image
                - "/home/ue4/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"
                - "/home/ue4/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"
                - "/home/ue4/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"
                # Windows image
                - "C:/UnrealEngine/Engine/Binaries/Win64/UE4Editor-Cmd.exe"
